<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>m(video)p</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d0d0d;
            --surface: #1a1714;
            --surface2: #252019;
            --beige: #f5f0e8;
            --beige-dim: #c4baa8;
            --beige-dark: #8a8070;
            --brown: #8b5a2b;
            --brown-light: #a67c52;
            --brown-glow: rgba(139, 90, 43, 0.3);
            --text: #f5f0e8;
            --text-dim: #8a8070;
            --success: #7dad68;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Main Layout */
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--surface2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--beige);
            letter-spacing: -0.02em;
        }

        .logo span {
            color: var(--brown-light);
        }

        /* Session Dropdown */
        .session-dropdown {
            position: relative;
        }

        .session-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--surface);
            border: 1px solid var(--surface2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .session-trigger:hover {
            border-color: var(--brown);
        }

        .session-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--beige);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .session-arrow {
            color: var(--text-dim);
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .session-dropdown.open .session-arrow {
            transform: rotate(180deg);
        }

        .session-menu {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            min-width: 220px;
            background: var(--surface);
            border: 1px solid var(--surface2);
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 50;
            overflow: hidden;
        }

        .session-dropdown.open .session-menu {
            display: block;
        }

        .session-menu-header {
            padding: 12px 14px;
            border-bottom: 1px solid var(--surface2);
        }

        .new-session-btn {
            width: 100%;
            padding: 10px 14px;
            background: var(--brown);
            border: none;
            border-radius: 6px;
            color: var(--beige);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .new-session-btn:hover {
            background: var(--brown-light);
        }

        .session-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .session-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            cursor: pointer;
            transition: background 0.1s;
            border-bottom: 1px solid var(--surface2);
        }

        .session-item:last-child {
            border-bottom: none;
        }

        .session-item:hover {
            background: var(--surface2);
        }

        .session-item.active {
            background: var(--brown-glow);
        }

        .session-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--surface2);
            flex-shrink: 0;
        }

        .session-indicator.has-video {
            background: var(--success);
        }

        .session-item-content {
            flex: 1;
            min-width: 0;
        }

        .session-item-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--beige);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .session-item-date {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .session-delete {
            opacity: 0;
            padding: 4px 8px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.1s;
        }

        .session-item:hover .session-delete {
            opacity: 1;
        }

        .session-delete:hover {
            background: #3a1a1a;
            color: #f5a0a0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Provider Selector */
        .provider-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--surface);
            border: 1px solid var(--surface2);
            border-radius: 8px;
        }

        .provider-selector label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
        }

        .provider-selector select {
            background: var(--surface2);
            border: none;
            color: var(--beige);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: inherit;
            cursor: pointer;
        }

        .provider-selector select:focus {
            outline: 1px solid var(--brown);
        }

        .confidence-pill {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--surface2);
            color: var(--text-dim);
            transition: all 0.3s;
        }

        .confidence-pill.ready {
            background: var(--brown);
            color: var(--beige);
        }

        .video-progress-btn {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--brown);
            color: var(--beige);
            border: none;
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Chat Area - Centered */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .messages {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 32px 0;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages::-webkit-scrollbar-thumb {
            background: var(--surface2);
            border-radius: 3px;
        }

        .message {
            display: flex;
            gap: 16px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .message.assistant .avatar {
            background: var(--brown);
            color: var(--beige);
        }

        .message.user .avatar {
            background: var(--beige-dark);
            color: var(--bg);
        }

        .message-body {
            flex: 1;
            max-width: 600px;
        }

        .message-content {
            padding: 16px 20px;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: var(--beige);
            color: var(--bg);
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: var(--surface);
            border: 1px solid var(--surface2);
            border-bottom-left-radius: 4px;
        }

        .assumptions {
            margin-top: 10px;
            padding: 12px 16px;
            background: var(--surface2);
            border-radius: 10px;
            font-size: 0.8rem;
            color: var(--text-dim);
            border-left: 3px solid var(--brown);
        }

        .assumptions strong {
            color: var(--brown-light);
        }

        /* Input Area */
        .input-area {
            flex-shrink: 0;
            padding: 24px 0 32px;
        }

        .input-container {
            background: var(--surface);
            border: 1px solid var(--surface2);
            border-radius: 16px;
            padding: 4px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-container:focus-within {
            border-color: var(--brown);
            box-shadow: 0 0 0 3px var(--brown-glow);
        }

        #messageInput {
            flex: 1;
            padding: 14px 16px;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 200px;
        }

        #messageInput::placeholder {
            color: var(--text-dim);
        }

        #sendBtn {
            padding: 12px 20px;
            background: var(--brown);
            border: none;
            border-radius: 12px;
            color: var(--beige);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
            margin: 4px;
        }

        #sendBtn:hover {
            background: var(--brown-light);
        }

        #sendBtn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Side Panel */
        .side-panel {
            width: 340px;
            background: var(--surface);
            border-left: 1px solid var(--surface2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--surface2);
        }

        .panel-header h2 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-dim);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .product-card {
            background: var(--bg);
            border: 1px solid var(--surface2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--beige);
            margin-bottom: 4px;
        }

        .product-tagline {
            color: var(--text-dim);
            font-size: 0.85rem;
            font-style: italic;
        }

        .style-badges {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .style-badge {
            padding: 5px 10px;
            background: var(--brown-glow);
            border: 1px solid var(--brown);
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--brown-light);
        }

        .field-group {
            margin-top: 16px;
        }

        .field-label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .field-value {
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--beige-dim);
        }

        .field-value.empty {
            color: var(--text-dim);
            font-style: italic;
        }

        .features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .feature-tag {
            padding: 4px 10px;
            background: var(--surface2);
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--beige-dim);
        }

        .panel-footer {
            padding: 20px;
            border-top: 1px solid var(--surface2);
        }

        #generateBtn {
            width: 100%;
            padding: 14px;
            background: var(--brown);
            border: none;
            border-radius: 10px;
            color: var(--beige);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        #generateBtn:hover:not(:disabled) {
            background: var(--brown-light);
        }

        #generateBtn:disabled {
            background: var(--surface2);
            color: var(--text-dim);
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .empty-state .icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.4;
        }

        .empty-state p {
            font-size: 0.875rem;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px 20px;
            background: var(--surface);
            border: 1px solid var(--surface2);
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--brown-light);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border: 1px solid var(--surface2);
            border-radius: 16px;
            max-width: 650px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 28px;
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 1.1rem;
            color: var(--beige);
        }

        .close-btn {
            background: var(--surface2);
            border: none;
            color: var(--text-dim);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        .close-btn:hover {
            color: var(--beige);
        }

        .scene {
            background: var(--bg);
            border: 1px solid var(--surface2);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .scene-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .scene-time {
            font-size: 0.8rem;
            color: var(--brown-light);
            font-weight: 600;
        }

        .scene-type {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-dim);
            letter-spacing: 0.05em;
        }

        .scene-visual {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .scene-narration {
            font-size: 0.95rem;
            font-style: italic;
            color: var(--beige-dim);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .side-panel {
                display: none;
            }
            .chat-area {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">m<span>(video)</span>p</div>
                <div class="session-dropdown" id="sessionDropdown">
                    <div class="session-trigger" onclick="toggleSessionMenu()">
                        <span class="session-name" id="currentSessionName">New Session</span>
                        <span class="session-arrow">&#9662;</span>
                    </div>
                    <div class="session-menu">
                        <div class="session-menu-header">
                            <button class="new-session-btn" onclick="createNewSession()">+ New Session</button>
                        </div>
                        <div class="session-list" id="sessionList">
                            <!-- Sessions populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div class="provider-selector">
                    <label>Provider:</label>
                    <select id="providerSelect" onchange="setProvider(this.value)">
                        <option value="wan">Wan (Alibaba)</option>
                        <option value="google">Google (Gemini/Veo)</option>
                    </select>
                </div>
                <button class="video-progress-btn" id="videoProgressBtn" style="display: none;" onclick="openModal()">Video in progress...</button>
                <span class="confidence-pill" id="confidencePill">Gathering context...</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Centered Chat -->
            <div class="chat-area">
                <div class="messages" id="messages">
                    <div class="message assistant">
                        <div class="avatar">m</div>
                        <div class="message-body">
                            <div class="message-content">
                                Tell me about your product idea. Don't worry about having everything figured out — give me the basics and I'll start piecing together your 10-second demo.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <input type="text" id="messageInput" placeholder="Describe your product idea..." autofocus>
                        <button id="sendBtn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>

            <!-- Side Panel -->
            <aside class="side-panel">
                <div class="panel-header">
                    <h2>Product Canvas</h2>
                </div>

                <div class="panel-content" id="canvasContent">
                    <div class="empty-state">
                        <div class="icon">◎</div>
                        <p>Your product takes shape here as we talk.</p>
                    </div>
                </div>

                <div class="panel-footer">
                    <button id="generateBtn" disabled onclick="generateScript()">
                        Generate Video Script
                    </button>
                </div>
            </aside>
        </main>
    </div>

    <!-- Script Modal -->
    <div class="modal" id="scriptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Video Script</h2>
                <div style="display: flex; gap: 8px;">
                    <button class="close-btn" onclick="regenerateScript()" title="Generate a new script">New Script</button>
                    <button class="close-btn" onclick="closeModal()">✕</button>
                </div>
            </div>
            <div id="scriptContent"></div>
        </div>
    </div>

    <script>
        let productUnderstanding = {};
        let isReady = false;
        let currentSessionId = null;
        let currentProvider = 'wan';  // Default provider

        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const generateBtn = document.getElementById('generateBtn');

        inputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) sendMessage();
        });

        // ============ Session Management ============

        async function initSession() {
            // Get current session ID from server
            try {
                const resp = await fetch('/api/current-session');
                if (resp.ok) {
                    const data = await resp.json();
                    currentSessionId = data.id;

                    // Load session data
                    const sessionResp = await fetch(`/api/sessions/${currentSessionId}`);
                    if (sessionResp.ok) {
                        const sessionData = await sessionResp.json();
                        restoreSessionState(sessionData);
                    }
                }
            } catch (err) {
                console.error('Failed to init session:', err);
            }

            // Load session list
            await loadSessionList();
        }

        function restoreSessionState(sessionData) {
            // Restore session name
            document.getElementById('currentSessionName').textContent = sessionData.name || 'New Session';

            // Restore product understanding
            if (sessionData.product_understanding && Object.keys(sessionData.product_understanding).length > 0) {
                productUnderstanding = sessionData.product_understanding;
                updateCanvas(productUnderstanding, sessionData.confidence || 0);
            }

            // Restore ready state
            isReady = sessionData.is_ready || false;
            generateBtn.disabled = !isReady;
            updateConfidencePill(sessionData.confidence || 0, isReady);

            // Restore conversation
            if (sessionData.conversation && sessionData.conversation.length > 0) {
                // Clear default message
                messagesEl.innerHTML = '';

                // Add back the initial assistant message
                addMessageHTML(`<div class="message-content">Tell me about your product idea. Don't worry about having everything figured out — give me the basics and I'll start piecing together your 10-second demo.</div>`, 'assistant');

                // Restore messages
                for (const msg of sessionData.conversation) {
                    if (msg.role === 'user') {
                        addMessage(msg.content, 'user');
                    } else {
                        try {
                            const data = JSON.parse(msg.content);
                            let html = `<div class="message-content">${data.message}</div>`;
                            if (data.assumptions_made && data.assumptions_made.length > 0) {
                                html += `<div class="assumptions"><strong>Assumptions:</strong> ${data.assumptions_made.join(' · ')}</div>`;
                            }
                            addMessageHTML(html, 'assistant');
                        } catch {
                            addMessage(msg.content, 'assistant');
                        }
                    }
                }
            }

            // Restore video state
            if (sessionData.video) {
                const video = sessionData.video;
                currentVideoId = video.id;
                if (video.script) {
                    currentScript = video.script;
                    currentScript.video_id = video.id;
                }
                if (video.keyframe_urls) {
                    keyframeUrls = video.keyframe_urls;
                }
                if (video.segment_urls) {
                    currentSegments = video.segment_urls;
                }
                if (video.stitched_url) {
                    restoredStitchedUrl = video.stitched_url;
                }
                if (video.stitched_url || video.script) {
                    // Show the video button
                    document.getElementById('videoProgressBtn').style.display = 'inline-block';
                    document.getElementById('videoProgressBtn').textContent = video.stitched_url ? 'View video' : 'View script';
                    generateBtn.textContent = 'View Video Script';
                }
            }
        }

        async function loadSessionList() {
            try {
                const resp = await fetch('/api/sessions');
                if (!resp.ok) return;

                const sessions = await resp.json();
                const listEl = document.getElementById('sessionList');

                if (sessions.length === 0) {
                    listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim); font-size: 0.85rem;">No previous sessions</div>';
                    return;
                }

                listEl.innerHTML = sessions.map(s => `
                    <div class="session-item ${s.id === currentSessionId ? 'active' : ''}" onclick="switchSession('${s.id}')">
                        <div class="session-indicator ${s.has_video ? 'has-video' : ''}"></div>
                        <div class="session-item-content">
                            <div class="session-item-name">${escapeHtml(s.name || 'Untitled')}</div>
                            <div class="session-item-date">${formatDate(s.updated_at)}</div>
                        </div>
                        <button class="session-delete" onclick="event.stopPropagation(); deleteSession('${s.id}')">Delete</button>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Failed to load sessions:', err);
            }
        }

        function toggleSessionMenu() {
            const dropdown = document.getElementById('sessionDropdown');
            const wasOpen = dropdown.classList.contains('open');
            dropdown.classList.toggle('open');

            // Refresh list when opening
            if (!wasOpen) {
                loadSessionList();
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('sessionDropdown');
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        async function createNewSession() {
            // Navigate to root without session param to create new
            window.location.href = '/';
        }

        async function switchSession(sessionId) {
            if (sessionId === currentSessionId) {
                document.getElementById('sessionDropdown').classList.remove('open');
                return;
            }
            window.location.href = `/?session=${sessionId}`;
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete this session and all its data?')) return;

            try {
                await fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });

                // If deleting current session, create new one
                if (sessionId === currentSessionId) {
                    window.location.href = '/';
                } else {
                    loadSessionList();
                }
            } catch (err) {
                console.error('Failed to delete session:', err);
            }
        }

        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // Initialize on page load
        initSession();
        initProvider();

        // ============ Provider Management ============

        async function initProvider() {
            try {
                const resp = await fetch('/api/providers');
                if (resp.ok) {
                    const data = await resp.json();
                    currentProvider = data.current.image || 'wan';
                    document.getElementById('providerSelect').value = currentProvider;
                }
            } catch (err) {
                console.error('Failed to init provider:', err);
            }
        }

        async function setProvider(provider) {
            try {
                const resp = await fetch('/api/set-provider', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: provider, video: provider })
                });
                if (resp.ok) {
                    const data = await resp.json();
                    currentProvider = data.current.image;
                    console.log('Provider set to:', currentProvider);
                }
            } catch (err) {
                console.error('Failed to set provider:', err);
            }
        }

        async function sendMessage() {
            const message = inputEl.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            inputEl.value = '';
            sendBtn.disabled = true;

            // Show typing indicator
            const typingEl = document.createElement('div');
            typingEl.className = 'message assistant';
            typingEl.innerHTML = `
                <div class="avatar">m</div>
                <div class="message-body">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            `;
            messagesEl.appendChild(typingEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                typingEl.remove();

                let html = `<div class="message-content">${data.message}</div>`;
                if (data.assumptions_made && data.assumptions_made.length > 0) {
                    html += `<div class="assumptions"><strong>Assumptions:</strong> ${data.assumptions_made.join(' · ')}</div>`;
                }
                addMessageHTML(html, 'assistant');

                if (data.product_understanding && Object.keys(data.product_understanding).length > 0) {
                    productUnderstanding = data.product_understanding;
                    updateCanvas(data.product_understanding, data.confidence);

                    // Update session name if product has a name
                    if (productUnderstanding.name) {
                        document.getElementById('currentSessionName').textContent = productUnderstanding.name;
                    }
                }

                isReady = data.ready_for_video;
                generateBtn.disabled = !isReady;

                updateConfidencePill(data.confidence, isReady);

            } catch (err) {
                typingEl.remove();
                addMessage('Something went wrong. Please try again.', 'assistant');
            }

            sendBtn.disabled = false;
            inputEl.focus();
        }

        function addMessage(text, role) {
            const el = document.createElement('div');
            el.className = `message ${role}`;
            el.innerHTML = `
                <div class="avatar">${role === 'user' ? 'Y' : 'm'}</div>
                <div class="message-body">
                    <div class="message-content">${escapeHtml(text)}</div>
                </div>
            `;
            messagesEl.appendChild(el);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function addMessageHTML(html, role) {
            const el = document.createElement('div');
            el.className = `message ${role}`;
            el.innerHTML = `
                <div class="avatar">m</div>
                <div class="message-body">${html}</div>
            `;
            messagesEl.appendChild(el);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function updateConfidencePill(confidence, ready) {
            const pill = document.getElementById('confidencePill');
            const pct = Math.round(confidence * 100);
            if (ready) {
                pill.textContent = 'Ready to generate';
                pill.classList.add('ready');
            } else {
                pill.textContent = `${pct}% context gathered`;
                pill.classList.remove('ready');
            }
        }

        function updateCanvas(product, confidence) {
            const content = document.getElementById('canvasContent');
            content.innerHTML = `
                <div class="product-card">
                    <div class="product-name">${product.name || 'Untitled Product'}</div>
                    <div class="product-tagline">${product.tagline || 'No tagline yet'}</div>
                    ${(product.tone || product.visual_style) ? `
                        <div class="style-badges">
                            ${product.tone ? `<span class="style-badge">${product.tone}</span>` : ''}
                            ${product.visual_style ? `<span class="style-badge">${product.visual_style}</span>` : ''}
                        </div>
                    ` : ''}
                </div>

                <div class="field-group">
                    <div class="field-label">Problem</div>
                    <div class="field-value ${!product.problem ? 'empty' : ''}">${product.problem || 'Not defined'}</div>
                </div>

                <div class="field-group">
                    <div class="field-label">Solution</div>
                    <div class="field-value ${!product.solution ? 'empty' : ''}">${product.solution || 'Not defined'}</div>
                </div>

                <div class="field-group">
                    <div class="field-label">Target User</div>
                    <div class="field-value ${!product.target_user ? 'empty' : ''}">${product.target_user || 'Not defined'}</div>
                </div>

                <div class="field-group">
                    <div class="field-label">Key Features</div>
                    ${product.key_features && product.key_features.length > 0
                        ? `<div class="features-list">${product.key_features.map(f => `<span class="feature-tag">${f}</span>`).join('')}</div>`
                        : '<div class="field-value empty">No features yet</div>'
                    }
                </div>
            `;
        }

        async function generateScript() {
            // If we already have a script, just show it
            if (currentScript) {
                openModal();
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating (this takes ~30s)...';

            console.log('Generating script for:', productUnderstanding);

            try {
                const response = await fetch('/generate-script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_understanding: productUnderstanding })
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const text = await response.text();
                    console.error('Server error:', text);
                    alert('Server error: ' + response.status);
                    return;
                }

                const script = await response.json();
                console.log('Script received:', script);

                if (script.error) {
                    alert('Error: ' + script.error);
                    return;
                }

                // Store video_id for later use
                if (script.video_id) {
                    currentVideoId = script.video_id;
                }

                showScript(script);
                generateBtn.textContent = 'View Video Script';

            } catch (err) {
                console.error('Fetch error:', err);
                alert('Network error: ' + err.message + '\n\nCheck browser console for details.');
            } finally {
                generateBtn.disabled = false;
            }
        }

        function resetScript() {
            currentScript = null;
            currentKeyframeTasks = [];
            currentSegments = [];
            keyframeUrls = {};
            isGenerating = false;
            currentVideoId = null;
            restoredStitchedUrl = null;
            document.getElementById('videoProgressBtn').style.display = 'none';
            generateBtn.textContent = 'Generate Video Script';
        }

        async function regenerateScript() {
            if (isGenerating) {
                if (!confirm('Video generation is in progress. Are you sure you want to start over?')) {
                    return;
                }
            }
            closeModal();
            resetScript();
            // Small delay then generate new script
            setTimeout(() => generateScript(), 100);
        }

        let currentScript = null;
        let currentKeyframeTasks = [];
        let currentSegments = [];
        let keyframeUrls = {};
        let isGenerating = false;
        let currentVideoId = null;

        function openModal() {
            document.getElementById('scriptModal').classList.add('active');
        }

        // Store stitched URL separately for restored sessions
        let restoredStitchedUrl = null;

        function showScript(script, stitchedUrl = null) {
            currentScript = script;
            const content = document.getElementById('scriptContent');
            const keyframes = script.keyframes || [];
            const segments = script.segments || [];

            // If we have a stitched video (from restoration), show it
            const hasStitchedVideo = stitchedUrl || restoredStitchedUrl;

            content.innerHTML = `
                <div id="videoContainer" style="margin-bottom: 20px;">
                    ${hasStitchedVideo ? `
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--brown-light); margin-bottom: 12px;">Final Video (15s)</div>
                            <div style="border-radius: 10px; overflow: hidden; background: var(--bg); border: 2px solid var(--brown);">
                                <video controls autoplay style="width: 100%; display: block;">
                                    <source src="${hasStitchedVideo}" type="video/mp4">
                                </video>
                            </div>
                            <a href="${hasStitchedVideo}" download style="display: inline-block; margin-top: 12px; padding: 10px 20px; background: var(--brown); color: var(--beige); border-radius: 6px; text-decoration: none; font-size: 0.85rem;">Download Video</a>
                        </div>
                    ` : ''}
                </div>

                ${keyframes.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim);">Keyframe-to-Video Pipeline (4 frames → 3 videos → 15s)</div>
                            <button id="generateVideoBtn" onclick="generateVideo()" style="padding: 10px 20px; font-size: 0.85rem; background: var(--brown); border: none; border-radius: 6px; color: var(--beige); cursor: pointer; font-weight: 600;">
                                ${hasStitchedVideo ? 'Regenerate Video' : 'Generate Video'}
                            </button>
                        </div>

                        <div style="font-size: 0.7rem; color: var(--text-dim); margin-bottom: 8px;">KEYFRAMES:</div>
                        ${keyframes.map(kf => `
                            <div style="background: var(--surface2); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div style="font-size: 0.7rem; font-weight: 600; color: var(--brown-light); margin-bottom: 4px;">Frame ${kf.frame}: ${kf.name}</div>
                                <div style="font-size: 0.8rem; color: var(--beige-dim);">${kf.image_prompt}</div>
                            </div>
                        `).join('')}

                        <div style="font-size: 0.7rem; color: var(--text-dim); margin: 12px 0 8px;">SEGMENTS:</div>
                        ${segments.map(seg => `
                            <div style="background: var(--brown-glow); border: 1px solid var(--brown); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div style="font-size: 0.7rem; font-weight: 600; color: var(--brown-light); margin-bottom: 4px;">
                                    Segment ${seg.segment}: ${seg.name} (Frame ${seg.first_frame} → ${seg.last_frame})
                                </div>
                                <div style="font-size: 0.8rem; color: var(--beige-dim);">${seg.motion_description}</div>
                            </div>
                        `).join('')}
                    </div>
                    ${script.visual_style ? `<div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 4px;"><strong>Style:</strong> ${script.visual_style}</div>` : ''}
                    ${script.color_palette ? `<div style="font-size: 0.8rem; color: var(--text-dim);"><strong>Colors:</strong> ${script.color_palette}</div>` : ''}
                ` : '<div style="background: var(--surface2); border-radius: 10px; padding: 20px; text-align: center; color: var(--text-dim);">No keyframes generated</div>'}
            `;
            document.getElementById('scriptModal').classList.add('active');
            // Show progress button so user can return to this modal
            document.getElementById('videoProgressBtn').style.display = 'inline-block';
            document.getElementById('videoProgressBtn').textContent = hasStitchedVideo ? 'View video' : 'View script';
        }

        async function generateVideo() {
            if (!currentScript?.keyframes?.length) return;

            const btn = document.getElementById('generateVideoBtn');
            const container = document.getElementById('videoContainer');
            const progressBtn = document.getElementById('videoProgressBtn');

            btn.disabled = true;
            btn.textContent = 'Phase 1: Generating keyframes...';
            isGenerating = true;
            progressBtn.style.display = 'inline-block';
            progressBtn.textContent = 'Generating keyframes...';
            container.innerHTML = `
                <div style="background: var(--surface2); border-radius: 10px; padding: 20px;">
                    <div style="color: var(--beige-dim); text-align: center; margin-bottom: 12px;">Phase 1: Generating 4 keyframe images...</div>
                    <div id="keyframeStatus" style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;">
                        ${currentScript.keyframes.map(kf => `<div class="kf-status" data-frame="${kf.frame}" style="padding: 6px 12px; background: var(--surface); border-radius: 6px; font-size: 0.75rem;">F${kf.frame}: Starting</div>`).join('')}
                    </div>
                    <div id="segmentStatus" style="display: flex; gap: 6px; justify-content: center; margin-top: 12px;">
                        <div class="seg-status" data-seg="1" style="padding: 6px 12px; background: var(--surface); border-radius: 6px; font-size: 0.75rem; opacity: 0.5;">Seg 1: Waiting</div>
                        <div class="seg-status" data-seg="2" style="padding: 6px 12px; background: var(--surface); border-radius: 6px; font-size: 0.75rem; opacity: 0.5;">Seg 2: Waiting</div>
                        <div class="seg-status" data-seg="3" style="padding: 6px 12px; background: var(--surface); border-radius: 6px; font-size: 0.75rem; opacity: 0.5;">Seg 3: Waiting</div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('/generate-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyframes: currentScript.keyframes,
                        segments: currentScript.segments,
                        provider: currentProvider
                    })
                });

                const data = await response.json();
                console.log('Generate keyframes response:', data);

                if (data.error) {
                    container.innerHTML = `<div style="background: #3a1a1a; border: 1px solid #8b3a3a; border-radius: 10px; padding: 16px; color: #f5a0a0;">${data.error}</div>`;
                    btn.disabled = false;
                    btn.textContent = 'Retry';
                    isGenerating = false;
                    document.getElementById('videoProgressBtn').textContent = 'View script';
                    return;
                }

                currentKeyframeTasks = data.keyframe_tasks;
                currentSegments = data.segments;
                pollKeyframeStatus();

            } catch (err) {
                console.error('Error:', err);
                container.innerHTML = `<div style="background: #3a1a1a; border: 1px solid #8b3a3a; border-radius: 10px; padding: 16px; color: #f5a0a0;">Error: ${err.message}</div>`;
                btn.disabled = false;
                btn.textContent = 'Retry';
                isGenerating = false;
                document.getElementById('videoProgressBtn').textContent = 'View script';
            }
        }

        async function pollKeyframeStatus() {
            const btn = document.getElementById('generateVideoBtn');
            let attempts = 0;
            const maxAttempts = 60;

            const poll = async () => {
                attempts++;
                let allDone = true;

                for (const kf of currentKeyframeTasks) {
                    const el = document.querySelector(`.kf-status[data-frame="${kf.frame}"]`);

                    if (kf.status === 'completed' && kf.url) {
                        keyframeUrls[kf.frame] = kf.url;
                        if (el) { el.style.background = '#1a3a1a'; el.style.color = '#7dad68'; el.textContent = `F${kf.frame}: Done ✓`; }
                    } else if (kf.status === 'error') {
                        if (el) { el.style.background = '#3a1a1a'; el.style.color = '#f5a0a0'; el.textContent = `F${kf.frame}: Failed`; }
                    } else if (kf.task_id) {
                        // Poll this task
                        try {
                            const provider = kf.provider || currentProvider;
                            const resp = await fetch(`/video-status/${kf.task_id}?provider=${provider}`);
                            const data = await resp.json();
                            if (data.status === 'completed' && data.result?.urls?.[0]) {
                                kf.status = 'completed';
                                kf.url = data.result.urls[0];
                                keyframeUrls[kf.frame] = kf.url;
                                if (el) { el.style.background = '#1a3a1a'; el.style.color = '#7dad68'; el.textContent = `F${kf.frame}: Done ✓`; }
                            } else if (data.status === 'error') {
                                kf.status = 'error';
                                if (el) { el.style.background = '#3a1a1a'; el.style.color = '#f5a0a0'; el.textContent = `F${kf.frame}: Failed`; }
                            } else {
                                allDone = false;
                                if (el) { el.textContent = `F${kf.frame}: ${data.task_status || 'Processing'}`; }
                            }
                        } catch (e) { allDone = false; }
                    } else {
                        allDone = false;
                    }
                }

                console.log(`Keyframe poll ${attempts}:`, keyframeUrls);

                if (allDone && Object.keys(keyframeUrls).length >= 4) {
                    btn.textContent = 'Phase 2: Generating videos...';
                    document.getElementById('videoProgressBtn').textContent = 'Generating videos...';
                    document.querySelectorAll('.seg-status').forEach(el => el.style.opacity = '1');
                    await startVideoGeneration();
                    return;
                }

                if (attempts >= maxAttempts) {
                    btn.disabled = false;
                    btn.textContent = 'Retry (keyframes timeout)';
                    return;
                }

                setTimeout(poll, 3000);
            };
            poll();
        }

        async function startVideoGeneration() {
            const btn = document.getElementById('generateVideoBtn');

            try {
                const response = await fetch('/generate-videos-from-keyframes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyframe_urls: keyframeUrls,
                        segments: currentScript.segments,
                        provider: currentProvider
                    })
                });

                const data = await response.json();
                console.log('Generate videos response:', data);

                if (data.error) {
                    document.getElementById('videoContainer').innerHTML += `<div style="margin-top: 12px; background: #3a1a1a; border-radius: 8px; padding: 12px; color: #f5a0a0;">${data.error}</div>`;
                    btn.disabled = false;
                    btn.textContent = 'Retry';
                    return;
                }

                currentSegments = data.segments;
                pollVideoStatus();

            } catch (err) {
                console.error('Error:', err);
                btn.disabled = false;
                btn.textContent = 'Retry';
            }
        }

        async function pollVideoStatus() {
            const btn = document.getElementById('generateVideoBtn');
            let attempts = 0;
            const maxAttempts = 90;

            const poll = async () => {
                attempts++;
                try {
                    const response = await fetch('/video-status-multi', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ segments: currentSegments })
                    });
                    const data = await response.json();
                    console.log(`Video poll ${attempts}:`, data);

                    data.segments.forEach(seg => {
                        const el = document.querySelector(`.seg-status[data-seg="${seg.segment}"]`);
                        if (el) {
                            if (seg.status === 'completed') {
                                el.style.background = '#1a3a1a';
                                el.style.color = '#7dad68';
                                el.textContent = `Seg ${seg.segment}: Done ✓`;
                            } else if (seg.status === 'error') {
                                el.style.background = '#3a1a1a';
                                el.style.color = '#f5a0a0';
                                el.textContent = `Seg ${seg.segment}: Failed`;
                            } else {
                                el.textContent = `Seg ${seg.segment}: ${seg.task_status || 'Processing'}`;
                            }
                        }
                    });

                    if (data.all_completed) {
                        const videoUrls = data.segments.filter(s => s.url).map(s => ({ segment: s.segment, url: s.url }));
                        console.log('Videos to stitch:', videoUrls);

                        if (videoUrls.length >= 2) {
                            btn.textContent = 'Phase 3: Stitching...';
                            document.getElementById('videoProgressBtn').textContent = 'Stitching video...';
                            await stitchVideos(videoUrls);
                        } else if (videoUrls.length === 1) {
                            // Only 1 video succeeded, show it directly
                            showCompletedVideos(videoUrls, null, `Only ${videoUrls.length} of 3 segments succeeded. Cannot stitch.`);
                        } else {
                            // No videos succeeded
                            document.getElementById('videoContainer').innerHTML = `<div style="background: #3a1a1a; border: 1px solid #8b3a3a; border-radius: 10px; padding: 16px; color: #f5a0a0;">All video segments failed to generate. Please retry.</div>`;
                        }

                        btn.textContent = 'Regenerate';
                        btn.disabled = false;
                        isGenerating = false;
                        document.getElementById('videoProgressBtn').textContent = videoUrls.length > 0 ? 'View video' : 'View script';
                        return;
                    }

                    if (attempts >= maxAttempts) {
                        btn.disabled = false;
                        btn.textContent = 'Retry (video timeout)';
                        return;
                    }

                    setTimeout(poll, 5000);
                } catch (err) {
                    console.error('Poll error:', err);
                    setTimeout(poll, 5000);
                }
            };
            poll();
        }

        async function stitchVideos(videos) {
            const container = document.getElementById('videoContainer');
            container.innerHTML = `
                <div style="background: var(--surface2); border-radius: 10px; padding: 20px; text-align: center;">
                    <div style="color: var(--beige-dim);">Stitching 3 segments into final video...</div>
                    <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 8px;">Downloading and combining with ffmpeg</div>
                </div>
            `;

            try {
                const response = await fetch('/stitch-videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videos, video_id: currentVideoId })
                });

                const data = await response.json();
                console.log('Stitch response:', data);

                if (data.error) {
                    showCompletedVideos(videos, null, data.error);
                    return;
                }

                showCompletedVideos(videos, data.url);

            } catch (err) {
                console.error('Stitch error:', err);
                showCompletedVideos(videos, null, err.message);
            }
        }

        function showCompletedVideos(videos, stitchedUrl = null, stitchError = null) {
            const container = document.getElementById('videoContainer');
            container.innerHTML = `
                ${stitchedUrl ? `
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--brown-light); margin-bottom: 12px;">✓ Final Stitched Video (15s)</div>
                        <div style="border-radius: 10px; overflow: hidden; background: var(--bg); border: 2px solid var(--brown);">
                            <video controls autoplay style="width: 100%; display: block;">
                                <source src="${stitchedUrl}" type="video/mp4">
                            </video>
                        </div>
                        <a href="${stitchedUrl}" download style="display: inline-block; margin-top: 12px; padding: 10px 20px; background: var(--brown); color: var(--beige); border-radius: 6px; text-decoration: none; font-size: 0.85rem;">Download Final Video</a>
                    </div>
                ` : ''}

                ${stitchError ? `
                    <div style="background: #3a1a1a; border: 1px solid #8b3a3a; border-radius: 10px; padding: 12px; margin-bottom: 16px; color: #f5a0a0; font-size: 0.85rem;">
                        Stitch failed: ${stitchError}. Individual segments below:
                    </div>
                ` : ''}

                <details ${stitchedUrl ? '' : 'open'}>
                    <summary style="cursor: pointer; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 12px;">Individual Segments</summary>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${videos.sort((a,b) => a.segment - b.segment).map(v => `
                            <div style="border-radius: 10px; overflow: hidden; background: var(--bg);">
                                <div style="padding: 8px 12px; background: var(--surface2); font-size: 0.75rem; color: var(--beige-dim);">Segment ${v.segment}</div>
                                <video controls style="width: 100%; display: block;">
                                    <source src="${v.url}" type="video/mp4">
                                </video>
                            </div>
                        `).join('')}
                    </div>
                </details>
            `;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                event.target.textContent = 'Copied!';
                setTimeout(() => { event.target.textContent = 'Copy'; }, 2000);
            });
        }

        function closeModal() {
            document.getElementById('scriptModal').classList.remove('active');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
