# Task: Wan 2.6 Reference-to-Video Mode (Phase 5)

## Your Assignment

Implement Wan 2.6 Reference-to-Video (R2V) mode for the video provider. R2V preserves visual characteristics of subjects by using reference images during video generation.

## Files to Modify

- `demo/providers/wan.py` - Add R2V support to WanVideoProvider

## Success Criteria (IMPORTANT)

Your task is complete when ALL tests pass:

```bash
cd demo && ../venv/bin/pytest tests/test_wan_r2v.py -v
```

**Run the tests frequently** as you implement. Do NOT mark this task as complete until all tests pass.

The tests define exactly what your implementation must do. Read them carefully to understand the requirements.

## What You Need to Implement

1. **`generate_video_r2v()` method** (or enhance `generate_video()`) that:
   - Accepts `reference_images: list[str]` parameter (URLs)
   - Uses `wan2.6-r2v` model when references are provided
   - Falls back to `wan2.2-kf2v-flash` when no references
   - Passes reference URLs to the Wan API

2. **Ensure prompts stay under 800 chars** for Wan 2.6:
   - The `PromptAssembler._compress_for_wan()` method already exists
   - Use `assemble_video_segment_prompt()` which auto-compresses

## Wan R2V API Details

Based on the Wan 2.6 documentation:
- Model: `wan2.6-r2v` (Reference-to-Video)
- Reference images preserve visual characteristics
- API accepts `video_urls` or `reference_images` parameter
- Prompt limit: 800 characters

Example API call structure:
```json
{
    "model": "wan2.6-r2v",
    "prompt": "person walking (under 800 chars)",
    "first_frame_url": "https://...",
    "last_frame_url": "https://...",
    "reference_images": ["https://ref1.png", "https://ref2.png"]
}
```

## Parallel Context

Other Claude instances are working on:
- **ref-images**: Implementing reference image generation endpoint

**DO NOT modify files assigned to the other worktree:**
- Do NOT touch `demo/app.py` (except if absolutely needed for video endpoints)
- Do NOT touch `demo/consistency/` files

## Dependencies

- None - can start immediately
- Reference images will be generated by the other worktree, but you can test with mock URLs

## Constraints

- Stay within `demo/providers/wan.py`
- Test with mocked API calls (the tests use unittest.mock)
- The actual Wan API may or may not be running locally

## Getting Started

1. **Read the test file first**: `demo/tests/test_wan_r2v.py`
2. **Create a task list** based on the tests using the TaskCreate tool
3. Update task status as you work (in_progress â†’ completed)
4. Run tests frequently to check progress

## Commit Strategy (IMPORTANT)

**Commit after completing each major piece of work.** This lets the orchestrator track your progress.

Example commits:
1. "Add generate_video_r2v method skeleton"
2. "Implement R2V API call with reference images"
3. "Add fallback to standard mode - tests passing"

## When Done

When you've completed all tasks:
1. **Verify all tests pass**: `cd demo && ../venv/bin/pytest tests/test_wan_r2v.py -v`
2. Make a final commit with all changes
3. **Clearly tell the user you're done** with:
   - Summary of what was implemented
   - Confirmation that all tests pass
   - Any notes for the merge phase
